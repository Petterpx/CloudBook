# ç”±æµ…å…¥æ·±ï¼Œè¯¦è§£ Lifecycle ç”Ÿå‘½å‘¨æœŸç»„ä»¶çš„é‚£äº›äº‹

![undraw_Photo_session_re_c0cp](../Downloads/202211222342022.png)

Hi,ä½ å¥½:)

## å¼•è¨€

åœ¨2022çš„ä»Šå¤©ï¼Œ`AndroidX` æ™®éçš„æƒ…å†µä¸‹ï¼Œ**JetPack Lifecycle** ä¹Ÿæ—©å·²ç»æˆä¸ºäº†å¼€å‘ä¸­çš„åŸºç¡€è®¾æ–½ï¼Œå°åˆ° `View(æ‰©å±•åº“)` ,å¤§åˆ° `Activity`ï¼Œéƒ½éšè—ç€å®ƒçš„èº«å½±ï¼Œè€Œäº†è§£ `Lifecycle` ä¹Ÿæ­£æ˜¯ç†è§£ `JetPack` ç»„ä»¶ç³»åˆ—åº“ç”Ÿå‘½æ„ŸçŸ¥è®¾è®¡çš„åŸºç¡€ã€‚

> æœ¬ç¯‡å®šä½ä¸­çº§ï¼Œå°†ä»èƒŒæ™¯åˆ°æºç å®ç°ï¼Œä»è€Œç†è§£å…¶èƒŒåçš„è®¾è®¡æ€æƒ³ã€‚

## å¯¼èˆª

çœ‹å®Œæœ¬ç¯‡ï¼Œä½ å°†ä¼šææ¸…ä»¥ä¸‹é—®é¢˜ï¼š

- `Lifecycle` çš„å‰ä¸–ä»Šç”Ÿï¼›
- `Lifecycle` å¯ä»¥å¹²ä»€ä¹ˆï¼›
- `Lifecycle` æºç è§£æï¼›

## èƒŒæ™¯

åœ¨å¼€å§‹å‰ï¼Œæˆ‘ä»¬å…ˆèŠèŠå…³äº `Lifecycle` çš„å‰ä¸–ä»Šç”Ÿï¼Œä»è€Œä¾¿äºæˆ‘ä»¬æ›´å¥½çš„ç†è§£ `Lifecycle` å­˜åœ¨çš„æ„ä¹‰ã€‚

### æ´ªè’ä¹‹æ—¶

åœ¨ `Lifecycle` ä¹‹å‰(ä¸æ’é™¤ç°åœ¨ğŸ˜‚)ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨æŸä¸ªç”Ÿå‘½å‘¨æœŸå»æ‰§è¡Œä¸€äº›æ“ä½œæ—¶ï¼Œç»å¸¸ä¼šåœ¨Actæˆ–è€…Fragmentå†™å¾ˆå¤šæ¨¡ç‰ˆä»£ç ï¼Œå¦‚ä¸‹ä¸¤ä¸ªç¤ºä¾‹ï¼š

1. æ¯”å¦‚ï¼Œæœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `Activity` å…³é—­æ—¶å°†å…¶å…³é—­ï¼Œä»è€Œé¿å…å› æ­¤å¯¼è‡´çš„å†…å­˜é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªç„¶ä¼šåœ¨ `onDestory()` ä¸­å»stopä¸€ä¸‹ã€‚è¿™äº›äº‹çœ‹èµ·æ¥ä¼¼ä¹ä¸éº»çƒ¦ï¼Œä½†å¦‚æœæ˜¯ä¸€ä¸ªé‡å¤å¤šå¤„ä½¿ç”¨çš„ä»£ç ï¼Œç»†å¿ƒçš„å¼€å‘è€…ä¼šå°†å…¶å•ç‹¬æŠ½ç¦»æˆä¸ºä¸€ä¸ª **case** ,ä»è€Œé€šè¿‡ç»„åˆçš„æ–¹å¼é™ä½æˆ‘ä»¬ä¸»ç±»ä¸­çš„é€»è¾‘ï¼Œä½†ä¸å¯é¿å…æˆ‘ä»¬ä¾ç„¶è¿˜è¦å­˜åœ¨å¥½å¤šæ¨¡ç‰ˆä»£ç ï¼Œå› ä¸ºæ¯æ¬¡éƒ½éœ€è¦ `onStop()` æ¸…ç†æˆ–è€…å…¶ä»–æ“ä½œ(é™¤éå†™åˆ°base,ä½†ä¸å¯æ¥å—â˜¹ï¸)ã€‚

**ğŸ“Œ å¦‚æœèƒ½ä¸éœ€è¦å¼€å‘è€…è‡ªå·±æ‰‹åŠ¨ï¼Œè¯¥æœ‰å¤šå¥½ï¼Ÿ**



2. åœ¨è€ç‰ˆæœ¬çš„å‹ç›Ÿä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ç”šè‡³éœ€è¦åœ¨åŸºç±»çš„ `Activity` ä¸­å¤å†™ `onResume()` ã€`onPause()` ç­‰æ–¹æ³•ï¼Œè¿™äº›äº‹æƒ…è¯´éº»çƒ¦ä¹Ÿä¸éº»çƒ¦ï¼Œä½†æ€»æ˜¯æ„Ÿè§‰å¾ˆä¸èˆ’æœã€‚ä¸è¿‡ï¼Œæœ‰ç»éªŒçš„å¼€å‘è€…è‚¯å®šä¼šæƒ³å–·ï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªä¸‰æ–¹åº“ï¼Œä½ å°±è‡ªå·±ä¸ä¼šé€šè¿‡`application.registerActivityLifecycleCallbacks` ç›‘å¬å—ğŸ¤ŒğŸ¼ã€‚

**ğŸ“Œ æ³¨æ„ï¼ŒApplicationæœ‰ç›‘å¬å…¨å±€Actç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ï¼ŒActä¹Ÿæœ‰è¿™ä¸ªæ–¹æ³•ã€‚ğŸ¤–**

### ç›˜å¤å¼€å¤©

åœ¨ **JetPack** ä¹‹å‰ï¼Œ`Android` ä¸€ç›´ç§‰æ‰¿ç€ä¼ ç»Ÿçš„ **MVC** æ¶æ„ï¼Œå³ `xml` ä½œä¸º **View**, `Activity` ä½œä¸º **Control** ï¼Œ`Model` å±‚ç”±æ•°æ®æ¨¡å‹æˆ–è€…ä»“åº“è€Œå®šã€‚è™½ç„¶è¯´å®˜æ–¹æ›¾ç»æœ‰ä¸€ä¸ªMVPçš„ç¤ºä¾‹,ä½†çœŸæ­£ç”¨çš„äººå¹¶ä¸å¤šã€‚å†åŠ ä¸Šå®˜æ–¹ä¸€ç›´ä¹Ÿæ²¡æ¨èè¿‡ `Android` çš„æ¶æ„æŒ‡å—ï¼Œè¿™å°±å¯¼è‡´ä¼ ç»Ÿçš„Androidå¼€å‘æ–¹å¼å’Œç³»ç»Ÿçš„ç¢ç‰‡åŒ–ä¸€æ ·â˜¹ï¸ï¼Œäº”èŠ±å…«é—¨ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œçœ¼çœ‹å‰ç«¯çš„MVVMå·²æ„ˆåŠ æˆç†Ÿï¼Œåæœ‰Flutterï¼Œå†åŠ ä¸Šå¼€å‘è€…çš„éœ€æ±‚ç­‰èƒŒæ™¯ä¸‹ï¼ŒGoogleäº2017å¹´å‘å¸ƒäº†æ–°çš„å¼€å‘æ¶æ„: **AAC**,å…¨å **Architecture**ï¼Œå¹¶ä¸”ä¼´éšç€ä¸€ç³»åˆ—ç›¸å…³ç»„ä»¶ï¼Œä»è€Œå¸®åŠ©å¼€å‘è€…æé«˜å¼€å‘ä½“éªŒï¼Œé™ä½é”™è¯¯æ¦‚ç‡ï¼Œå‡å°‘æ¨¡ç‰ˆä»£ç ã€‚

è€Œæœ¬ç¯‡çš„ä¸»é¢˜ `Lifecycle` æ­£æ˜¯å…¶ä¸­ä½œä¸ºåŸºç¡€è®¾æ–½çš„å­˜åœ¨ï¼Œåœ¨ **sdk26** ä¹‹åï¼Œæ›´æ˜¯è¢«å†™å…¥äº†åŸºç¡€åº“ä¸­ã€‚

**é‚£Lifecycleåˆ°åº•æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿ**

> `Lifecycle` åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå…¶å°±æ˜¯ç”¨äºæ£€æµ‹ç»„ä»¶(`Fragment`ã€`Act`) çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»è€Œä¸å¿…å¼ºä¾èµ–äº `Activity` ä¸ `Fragment` ,å¸®åŠ©å¼€å‘è€…é™ä½æ¨¡ç‰ˆä»£ç ã€‚

## å¸¸è§ç”¨æ³•

åœ¨å®˜ç½‘ä¸­ï¼Œå¯¹äº `Lifecycle` çš„æ•´ä¸ªæµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š

![ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ç¤ºæ„å›¾](https://developer.android.com/static/images/topic/libraries/architecture/lifecycle-states.svg?hl=zh-cn)

### Apiä»‹ç»

**ç›¸å…³å­—æ®µ**

- **Event**

  ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œå¯¹åº”å…·ä½“çš„ç”Ÿå‘½å‘¨æœŸ:

  `ON_CREATE`, `ON_START`, `ON_RESUME`, `ON_PAUSE`, `ON_STOP`, `ON_DESTROY`, `ON_ANY`

- **State**

  ç”Ÿå‘½å‘¨æœŸçŠ¶æ€èŠ‚ç‚¹ï¼Œä¸ **Event** ç´§å¯†å…³è”ï¼Œ**Event** æ˜¯è¿™äº›ç»“ç‚¹çš„å…·ä½“è¾¹ç•Œ,æ¢å¥è¯è¯´ï¼Œ**State** ä»£è¡¨äº†è¿™ä¸€æ—¶åˆ»çš„å…·ä½“çŠ¶æ€,å…¶ç›¸å½“äºä¸€ä¸ªèŒƒå›´é›†ï¼Œåœ¨è¿™ä¸ªèŒƒå›´é‡Œï¼Œéƒ½æ˜¯è¿™ä¸ªçŠ¶æ€ã€‚è€ŒEventä»£è¡¨è¿™ä¸€çŠ¶æ€é›†é‡Œé¢è§¦å‘çš„å…·ä½“äº‹ä»¶æ˜¯ä»€ä¹ˆã€‚

  - `INITIALIZED`

    æ„é€ å‡½æ•°åˆå§‹åŒ–æ—¶ï¼Œä¸”æœªæ”¶åˆ° `onCreate()` äº‹ä»¶æ—¶çš„çŠ¶æ€;

  - `CREATED`

    åœ¨ `onCreate()` è°ƒç”¨ä¹‹åï¼Œ`onStop()` è°ƒç”¨ä¹‹å‰çš„çŠ¶æ€;

  - `STARTED`

    åœ¨ `onStart()` è°ƒç”¨ä¹‹åï¼Œ`onPause()` è°ƒç”¨ä¹‹å‰çš„çŠ¶æ€;

  - `RESUMED`

    åœ¨ `onResume()` è°ƒç”¨æ—¶çš„çŠ¶æ€;
    
  - `DESTROYED`
  
    `onDestory()` è°ƒç”¨æ—¶çš„çŠ¶æ€;

**ç›¸å…³æ¥å£**

- **LifecycleObserver**

  åŸºç¡€ `Lifecycler` å®ç°æ¥å£,ä¸€èˆ¬è°ƒç”¨ä¸åˆ°,å¯ç”¨äºè‡ªå®šä¹‰çš„ç»„ä»¶ï¼Œä»è€Œé¿å…åœ¨ `Act` æˆ–è€… `Fragment` ä¸­çš„æ¨¡ç‰ˆä»£ç ,ä¾‹å¦‚`ViewTreeLifecyleOwner` ï¼›

- **LifecycleEventObserver**

  å¯ä»¥æ¥å—æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸå˜åŒ–çš„æ¥å£ï¼›

- **FullLifecycleObserver**

  ç”¨äºç›‘å¬ç”Ÿå‘½å‘¨æœŸå˜åŒ–çš„æ¥å£ï¼Œæä¾›äº† `onCreate()`ã€`onStart()`ã€`onPause()`ã€`onStop()`ã€`onDestory()`ã€`onAny()`;

- **DefaultLifecycleObserver**

  `FullLifecycleObserver` çš„é»˜è®¤å®ç°ç‰ˆæœ¬,ç›¸æ¯”å‰è€…ï¼Œå¢åŠ äº†é»˜è®¤ `null` å®ç°ï¼›

### ä¸¾ä¸ªæ —å­

å¦‚ä¸‹æ‰€ç¤ºï¼Œé€šè¿‡å®ç° `DefaultLifecycleObserver` æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸­é‡å†™æˆ‘ä»¬æƒ³è¦ç›‘å¬çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä»è€Œå°†ä¸šåŠ¡ä»£ç ä»ä¸»ç±»ä¸­æ‹†ç¦»å‡ºæ¥ï¼Œä¸”æ›´ä¾¿äºå¤ç”¨ã€‚æœ€ååœ¨ç›¸å…³ç±»ä¸­ç›´æ¥ä½¿ç”¨ `lifecycle.addObserver()` æ–¹æ³•æ·»åŠ å®ä¾‹å³å¯ï¼Œè¿™ä¹Ÿæ˜¯googleæ¨èçš„ç”¨æ³•ã€‚

![image-20221124221438346](https://raw.githubusercontent.com/Petterpx/ImageRespoisty/main/img/202211242214425.png)

> ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `viewLifecycle` ,è€Œä¸æ˜¯ `lifecycle` ,è¿™é‡Œé¡ºä¾¿æä¸€ä¸‹ã€‚
>
> è§åä¹‹æ„ï¼Œå‰è€…æ˜¯è§†å›¾(view)ç”Ÿå‘½å‘¨æœŸï¼Œåè€…åˆ™æ˜¯éè§†å›¾çš„ç”Ÿå‘½å‘¨æœŸï¼Œå…·ä½“åŒºåˆ«å¦‚ä¸‹ï¼š
>
> `viewLifecycle` åªä¼šåœ¨ **onCreateView-onDestroyView** ä¹‹é—´æœ‰æ•ˆã€‚
>
> `lifecycle` åˆ™æ˜¯ä»£è¡¨ Fragment çš„ç”Ÿå‘½å‘¨æœŸ,åœ¨è§†å›¾æœªåˆ›å»ºæ—¶ï¼Œ`onCreate()`,`onDestory()` æ—¶ä¹Ÿä¼šè¢«è°ƒç”¨åˆ°ã€‚

---

æˆ–è€…ä½ æœ‰æŸä¸ªè‡ªå®šä¹‰View,æƒ³æ„ŸçŸ¥Fragmentæˆ–è€…Actçš„ç”Ÿå‘½å‘¨æœŸï¼Œä»è€Œåšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚Bannerç»„ä»¶ç­‰ï¼Œä¸ä¸Šé¢ç¤ºä¾‹ç±»ä¼¼ï¼š

![image-20221124221449371](https://raw.githubusercontent.com/Petterpx/ImageRespoisty/main/img/202211242214391.png)

> å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä¾èµ–ï¼š**androidx.lifecycle:lifecycle-runtime** æ‰©å±•åº“ã€‚
>
> ä»è€Œä½¿ç”¨ `view.findViewTreeLifecycleOwner()` çš„æ‰©å±•å‡½æ•°è·å¾—ä¸€ä¸ª `LifecycleOwner`,ä»è€Œåœ¨Viewå†…éƒ¨è‡ªè¡Œç›‘å¬ç”Ÿå‘½å‘¨æœŸ,å…é™¤åœ¨Activityæ‰‹åŠ¨æ·»åŠ è§‚å¯Ÿè€…çš„æ¨¡ç‰ˆä»£ç ã€‚
>
> ~~lifecycle.addObserver(view)~~

## æºç è§£æ

### Lifecycle

> åœ¨å®˜æ–¹çš„è§£é‡Šé‡Œï¼ŒLifecycle æ˜¯ä¸€ä¸ªç±»ï¼Œç”¨äºå­˜å‚¨æœ‰å…³ç»„ä»¶(Actæˆ–Fragment)å£°æ˜å‘¨æœŸçŠ¶æ€æ–°çš„ç±»ï¼Œå¹¶å…è®¸å…¶ä»–å¯¹è±¡è§‚å¯Ÿæ­¤ç±»ã€‚

ç›´æ¥å»çœ‹ `Lifecycle` çš„æºç ï¼Œå…¶å®ç°æ–¹å¼å¦‚ä¸‹ï¼š

![image-20221124221501409](https://raw.githubusercontent.com/Petterpx/ImageRespoisty/main/img/202211242215446.png)

æ€»ä½“è®¾è®¡å¦‚ä¸Šæ‰€ç¤º,æ¯”è¾ƒç®€å•,å°±æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„æ¥å£æ¨¡ç‰ˆï¼š

> ä½¿ç”¨è€…å®ç° `LifecycleObserver` æ¥å£(),ç„¶åè°ƒç”¨ **addObserver()** æ·»åŠ åˆ°è§‚å¯Ÿè€…åˆ—è¡¨ï¼Œå–æ¶ˆè§‚å¯Ÿè€…æ—¶è°ƒç”¨ **rmeoveObserver()** ç§»é™¤æ‰å³å¯ã€‚åœ¨ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸå˜åŠ¨æ—¶ï¼Œéå†è§‚å¯Ÿè€…åˆ—è¡¨ï¼Œç„¶åé€šçŸ¥å®ç°äº† `LifecycleObserver` çš„å®ä¾‹ï¼Œä»è€Œè°ƒç”¨ç›¸åº”çš„æ–¹æ³•ã€‚

å› ä¸ºå…¶æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨çš„ä¸€èˆ¬éƒ½æ˜¯å®ƒçš„å…·ä½“å®ç°ç±»ï¼Œä¹Ÿå°±æ˜¯ `LifecycleRegistry` ,ç›®å‰ä¹Ÿæ˜¯å…¶çš„å”¯ä¸€å®ç°ç±»ã€‚

---

### LifecycleRegistry

`Lifecycle` çš„å…·ä½“å®ç°è€…,å¦‚åæ‰€ç¤ºï¼Œä¸»è¦ç”¨äºç®¡ç†å½“å‰è®¢é˜…çš„ è§‚å¯Ÿè€…å¯¹è±¡ ,æ‰€ä»¥ä¹Ÿæ‰¿æ‹…äº† `Lifecycle` å…·ä½“çš„å®ç°é€»è¾‘ã€‚å› ä¸ºæºç è¾ƒé•¿,æ‰€ä»¥æˆ‘ä»¬åšäº†ä¸€äº›åˆ å‡ï¼Œåªéœ€å…³æ³¨ä¸»æµç¨‹å³å¯ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š

```java
public class LifecycleRegistry extends Lifecycle {
	
  	// ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…map,LifecycleObserveræ˜¯è§‚å¯Ÿè€…æ¥å£,ObserverWithStateå…·ä½“çš„çŠ¶æ€åˆ†å‘çš„åŒ…è£…ç±»
    private FastSafeIterableMap<LifecycleObserver, ObserverWithState> mObserverMap;
  	// å½“å‰ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
    private State mState = INITIALIZED;
  	// æŒæœ‰ç”Ÿå‘½å‘¨æœŸçš„æä¾›å•†,Activityæˆ–è€…Fragmentçš„å¼±å¼•ç”¨
    private final WeakReference<LifecycleOwner> mLifecycleOwner;
  	// å½“å‰æ­£åœ¨æ·»åŠ çš„è§‚å¯Ÿè€…æ•°é‡,é»˜è®¤ä¸º0,è¶…è¿‡0åˆ™è®¤ä¸ºå¤šçº¿ç¨‹è°ƒç”¨
    private int mAddingObserverCounter = 0;
  	// æ˜¯å¦æ­£åœ¨åˆ†å‘äº‹ä»¶
    private boolean mHandlingEvent = false;
  	// æ˜¯å¦æœ‰æ–°çš„äº‹ä»¶äº§ç”Ÿ
    private boolean mNewEventOccurred = false;
  	// å­˜å‚¨ä¸»ç±»çš„äº‹ä»¶state
    private ArrayList<State> mParentStates = new ArrayList<>();

    @Override
    public void addObserver(@NonNull LifecycleObserver observer) {
        // åˆå§‹åŒ–çŠ¶æ€,destory or init
        State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;
      	// ğŸ“Œ åˆå§‹åŒ–å®é™…åˆ†å‘çŠ¶æ€çš„åŒ…è£…ç±»
        ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);
      	// å°†è§‚å¯Ÿè€…æ·»åŠ åˆ°å…·ä½“çš„mapä¸­,å¦‚æœå·²ç»å­˜åœ¨äº†åˆ™è¿”å›ä¹‹å‰çš„,å¦åˆ™åˆ›å»ºæ–°çš„æ·»åŠ åˆ°mapä¸­
        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);
				// å¦‚æœä¸Šä¸€æ­¥æ·»åŠ æˆåŠŸäº†,putIfAbsentä¼šè¿”å›null
        if (previous != null) {
            return;
        }
      	// å¦‚æœactæˆ–è€…ffè¢«å›æ”¶äº†,ç›´æ¥return
        LifecycleOwner lifecycleOwner = mLifecycleOwner.get();
        if (lifecycleOwner == null) {
            return;
        }
				// å½“å‰æ·»åŠ çš„è§‚å¯Ÿè€…æ•°é‡!=0||æ­£åœ¨å¤„ç†äº‹ä»¶
        boolean isReentrance = mAddingObserverCounter != 0 || mHandlingEvent;
      	// ğŸ“Œ å–å¾—è§‚å¯Ÿè€…å½“å‰çš„çŠ¶æ€
        State targetState = calculateTargetState(observer);
        mAddingObserverCounter++;
      	// ğŸ“Œ å¦‚æœå½“å‰è§‚å¯Ÿè€…çŠ¶æ€å°äºå½“å‰ç”Ÿå‘½å‘¨æœŸæ‰€åœ¨çŠ¶æ€&&è¿™ä¸ªè§‚å¯Ÿè€…å·²ç»è¢«å­˜åˆ°äº†è§‚å¯Ÿè€…åˆ—è¡¨ä¸­
        while ((statefulObserver.mState.compareTo(targetState) < 0
                && mObserverMap.contains(observer))) {
          	// ä¿å­˜å½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
            pushParentState(statefulObserver.mState);
          	// è¿”å›å½“å‰ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å¯¹åº”çš„æ¥ä¸‹æ¥çš„äº‹ä»¶åºåˆ—
            final Event event = Event.upFrom(statefulObserver.mState);
            ...
            // åˆ†å‘äº‹ä»¶
            statefulObserver.dispatchEvent(lifecycleOwner, event);
          	// ç§»é™¤å½“å‰çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€
            popParentState();
            // å†æ¬¡è·å¾—å½“å‰çš„çŠ¶æ€,ä»¥ä¾¿ç»§ç»­æ‰§è¡Œ
            targetState = calculateTargetState(observer);
        }
				
      	// å¤„ç†ä¸€éäº‹ä»¶,ä¿è¯äº‹ä»¶åŒæ­¥
        if (!isReentrance) {
            sync();
        }
      	// å›å½’é»˜è®¤å€¼
        mAddingObserverCounter--;
    }
		...
    static class ObserverWithState {
        State mState;
        LifecycleEventObserver mLifecycleObserver;

        ObserverWithState(LifecycleObserver observer, State initialState) {
          	// åˆå§‹åŒ–äº‹ä»¶è§‚å¯Ÿè€…
            mLifecycleObserver = Lifecycling.lifecycleEventObserver(observer);
            mState = initialState;
        }

        void dispatchEvent(LifecycleOwner owner, Event event) {
            State newState = event.getTargetState();
            mState = min(mState, newState);
            mLifecycleObserver.onStateChanged(owner, event);
            mState = newState;
        }
    }
  	...
}
```

æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„æ˜¯ `addObserver()` å³è®¢é˜…ç”Ÿå‘½å‘¨æœŸå˜æ›´æ—¶çš„é€»è¾‘,å…·ä½“å¦‚ä¸‹ï¼š

1. å…ˆåˆå§‹åŒ–å½“å‰è§‚å¯Ÿè€…çš„çŠ¶æ€ï¼Œé»˜è®¤ä¸¤ç§ï¼Œå³ `DESTROYED`(é”€æ¯) æˆ–è€… `INITIALIZED`(æ— æ•ˆ)ï¼Œåˆ†åˆ«å¯¹åº” `onDestory()` å’Œ `onCreate()` ä¹‹å‰ï¼›
2. åˆå§‹åŒ– **çŠ¶æ€è§‚å¯Ÿè€…(ObserverWithState)**ï¼Œå†…éƒ¨ä½¿ç”¨ `Lifecycling.lifecycleEventObserver()` å°†æˆ‘ä»¬ä¼ é€’è¿›æ¥çš„ **ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…(LifecycleObser)** åŒ…è£…ä¸ºä¸€ä¸ª **ç”Ÿå‘½å‘¨æœŸ[äº‹ä»¶]è§‚å¯Ÿè€…LifecycleEventObserver**ï¼Œä»è€Œåœ¨çŠ¶æ€å˜æ›´æ—¶è§¦å‘äº‹ä»¶é€šçŸ¥ï¼›
3. å°†ç¬¬äºŒæ­¥ç”Ÿæˆçš„çŠ¶æ€è§‚å¯Ÿè€…æ·»åŠ åˆ°ç¼“å­˜mapä¸­,å¦‚æœä¹‹å‰å·²ç»å­˜åœ¨ï¼Œåˆ™åœæ­¢æ¥ä¸‹æ¥çš„æ“ä½œ,å¦åˆ™ç»§ç»­åˆå§‹åŒ–ï¼›
4. è°ƒç”¨ `calculateTargetState()` è·å¾—å½“å‰çœŸæ­£çš„çŠ¶æ€ã€‚
5. å¼€å§‹äº‹ä»¶è½®è®­ï¼Œå¦‚æœ **å½“å‰è§‚å¯Ÿè€…çš„çŠ¶æ€å°äºæ­¤æ—¶çœŸæ­£çš„çŠ¶æ€** && **è§‚å¯Ÿè€…å·²ç»è¢«æ·»åŠ åˆ°äº†ç¼“å­˜åˆ—è¡¨** ä¸­ï¼Œåˆ™è·å¾—å½“å‰è§‚å¯Ÿè€…ä¸‹ä¸€ä¸ªçŠ¶æ€ï¼Œå¹¶è§¦å‘ç›¸åº”çš„äº‹ä»¶é€šçŸ¥ `dispatchEvent()`,ç„¶åç»§ç»­è½®è®­ã€‚ç›´åˆ°ä¸æ»¡è¶³åˆ¤æ–­æ¡ä»¶ï¼›

> éœ€è¦æ³¨æ„çš„æ˜¯, å…³äºçŠ¶æ€çš„åˆ¤æ–­,è¿™é‡Œä½¿ç”¨äº†**compareTo()**,ä»è€Œåˆ¤æ–­å½“å‰çŠ¶æ€æšä¸¾æ˜¯å¦å°äºæŒ‡å®šçŠ¶æ€ã€‚

---



### Activityä¸­çš„å®ç°

**Tips:** 

å†™è¿‡æƒé™æ£€æµ‹åº“çš„å°ä¼™ä¼´ï¼Œåº”è¯¥å¾ˆç†Ÿæ‚‰ï¼Œä¸ºäº†é¿å…åœ¨ `Activity` ä¸­æ‰‹åŠ¨å®ç° `onActivityRequest()` ,ä»è€Œå®ç°ä»¥å›è°ƒçš„æ–¹å¼è·å¾—æƒé™ç»“æœï¼Œæˆ‘ä»¬å¾€å¾€ä¼šä½¿ç”¨ä¸€ä¸ªé€æ˜çš„ `Fragment` ,ä»è€Œå°†æ¨¡ç‰ˆæ–¹æ³•æ‹†ç¦»åˆ°å•ç‹¬ç±»ä¸­ï¼Œè€Œè¿™ç§å®ç°æ–¹å¼æ­£æ˜¯ç»„åˆçš„æ€æƒ³ã€‚

è€Œ `Lifecycle` åœ¨ **Activity** ä¸­çš„å®ç°æ­£æ˜¯ä¸Šè¿°çš„æ–¹å¼ã€‚

---

å¦‚ä¸‹æ‰€ç¤ºï¼Œå½“æˆ‘ä»¬åœ¨ `Activity` ä¸­è°ƒç”¨ `lifecycle` å¯¹è±¡æ—¶,å†…éƒ¨å®é™…ä¸Šæ˜¯è°ƒç”¨äº† **ComponentActivity.mLifecycleRegistry**,å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š

![image-20221124221515122](https://raw.githubusercontent.com/Petterpx/ImageRespoisty/main/img/202211242215162.png)

ä¸éš¾å‘ç°ï¼Œåœ¨æˆ‘ä»¬çš„ `Activity` åˆå§‹åŒ–æ—¶,ç›¸åº”çš„ `LifecycleRegistry` å·²ç»è¢«åˆå§‹åŒ–ã€‚

åœ¨ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼Œä¸ºäº†é¿å…å¯¹åŸºç±»çš„å…¥ä¾µï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨ç»„åˆçš„æ–¹å¼ï¼Œæ‰€ä»¥è¿™é‡Œçš„ `ReportFragment` æ­£æ˜¯ `Lifecycle` åœ¨ `Activity` ä¸­å…·ä½“çš„é€»è¾‘æ‰¿è½½æ–¹,å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š

**ReportFragment.injectIfNeededIn**

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3d1468d2af65413ba589f9337f72d9af~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp?)

------



å†…éƒ¨ä¼šå¯¹sdkè¿›è¡Œåˆ¤æ–­ï¼Œå¯¹åº”ç€ä¸¤å¥—æµç¨‹ï¼Œå¯¹äº **sdk>=29** çš„,é€šè¿‡æ³¨å†Œ `Activity.registerActivityLifecycleCallbacks()` äº‹ä»¶å®ç°ç›‘å¬ï¼Œå¯¹äº **sdk<29** çš„,é‡å†™ `Fragment` ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•å®Œæˆã€‚



**ReportFragment å…·ä½“é€»è¾‘å¦‚ä¸‹ï¼š**

![image-20221124221612104](https://raw.githubusercontent.com/Petterpx/ImageRespoisty/main/img/202211242216146.png)



---

### Fragmentä¸­çš„å®ç°

ç›´æ¥å» Fragment.`lifecycle` ä¸­çœ‹ä¸€ä¸‹å³å¯,ä¼ªä»£ç å¦‚ä¸‹:

![image-20221123105600533](https://raw.githubusercontent.com/Petterpx/ImageRespoisty/main/img/202211231056561.png)

æ€»ç»“å¦‚ä¸‹ï¼š`lifecycle` å®ä¾‹ä¼šåœ¨ **Fragment** æ„é€ å‡½æ•° ä¸­è¿›è¡Œåˆå§‹åŒ–,è€Œ `mViewLifecycleOwner` ä¼šåœ¨ **performCreateView()** æ‰§è¡Œæ—¶åˆå§‹åŒ–,ç„¶ååœ¨ç›¸åº”çš„ **performXxx** ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæ—¶,è°ƒç”¨ç›¸åº”çš„ `lifecycle.handleLifecycleEvent()` ä»è€Œå®Œæˆäº‹ä»¶çš„é€šçŸ¥ã€‚

## æ€»ç»“

`Lifecycle` ä½œä¸º `JetPack` çš„åŸºçŸ³ï¼Œè€Œç†è§£å…¶æ˜¯æˆ‘ä»¬è´¯ç©¿ç›¸åº”ç”Ÿå‘½å‘¨æœŸçš„å…³é”®æ‰€åœ¨ã€‚

å…³äºç”Ÿå‘½å‘¨æœŸçš„é€šçŸ¥ï¼Œ`Lifecycle` å¹¶æ²¡æœ‰é‡‡ç”¨ç›´æ¥é€šçŸ¥çš„æ–¹å¼,è€Œæ˜¯é‡‡ç”¨äº† **Event(äº‹ä»¶)** + **State(çŠ¶æ€)** çš„è®¾è®¡æ–¹å¼ã€‚

> - å¯¹äºå¤–éƒ¨ç”Ÿå‘½å‘¨æœŸè®¢é˜…è€…è€Œè¨€ï¼Œåªéœ€è¦å…³æ³¨äº‹ä»¶ `Event` çš„è°ƒç”¨ï¼›
> - è€Œå¯¹äº`Lifecycle`è€Œè¨€,å…¶å†…éƒ¨åªå…³æ³¨ `State` ï¼Œå¹¶å°†ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ä¸ºäº†å¤šä¸ªé˜¶æ®µ,æ¯ä¸ªçŠ¶æ€åˆä»£è¡¨äº†ä¸€ä¸ªäº‹ä»¶é›†ï¼Œä»è€Œå¯¹äºå¤–éƒ¨è°ƒç”¨è€…è€Œè¨€ï¼Œæ— éœ€æ‹˜æ³¥äºå½“å‰å…·ä½“çš„çŠ¶æ€æ˜¯ä»€ä¹ˆã€‚

åœ¨å…·ä½“çš„å®ç°åº•å±‚ä¸Šé¢: 

> - åœ¨ `Activity` ä¸­ï¼Œé‡‡ç”¨ç»„åˆçš„æ–¹å¼è€Œéç»§æ‰¿ï¼Œåœ¨ **Activity.onCreate()** è§¦å‘æ—¶ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ªé€æ˜`Fragment`,ä»è€Œå°†é€»è¾‘å­˜äºå…¶ä¸­ã€‚å¯¹äº**sdk>=29**çš„ç‰ˆæœ¬ï¼Œå› ä¸º `Activity` æœ¬èº«æœ‰ç›‘å¬ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•,ä»è€Œç›´æ¥æ³¨å†Œç›‘å¬å™¨ï¼Œå¹¶åœ¨ç›¸åº”çš„ä¼šè°ƒç”¨è§¦å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶æ›´æ–°;å¯¹äº**sdk<29**çš„ç‰ˆæœ¬ï¼Œå› ä¸ºéœ€è¦å…¼å®¹æ—§ç‰ˆæœ¬,æ‰€ä»¥é‡å†™äº† `Fragment` ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä»è€Œå®ç°æ‰‹åŠ¨è§¦å‘æ›´æ–°æˆ‘ä»¬çš„ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…ã€‚
> - åœ¨ `Fragment` ä¸­,ä¼šåœ¨ `Fragment` æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ç›¸åº”çš„ `Lifecycle` ,å¹¶é‡å†™ç›¸åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä»è€Œè§¦å‘äº‹ä»¶é€šçŸ¥,å®ç°ç”Ÿå‘½å‘¨æœŸè§‚å¯Ÿè€…çš„æ›´æ–°ã€‚

æ¯å½“æˆ‘ä»¬è°ƒç”¨ `addObserver()` æ·»åŠ æ–°çš„è§‚å¯Ÿè€…æ—¶ï¼š

> å†…éƒ¨éƒ½ä¼šå¯¹æˆ‘ä»¬çš„è§‚å¯Ÿè€…è¿›è¡ŒåŒ…è£…ï¼Œå¹¶å°†å…¶åŒ…è£…ä¸ºä¸€ä¸ªå…·ä½“çš„äº‹ä»¶è§‚å¯Ÿè€… `LifecycleEventObserver`,ä»¥åŠç”Ÿæˆå½“å‰çš„è§‚å¯Ÿè€…å¯¹åº”çš„çŠ¶æ€å®ä¾‹(å†…éƒ¨æŒæœ‰`LifecycleEventObserver`)ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ° **ç¼“å­˜map** ä¸­ã€‚æ¥ç€ä¼šå»å¯¹æ¯”å½“å‰çš„ **è§‚å¯Ÿè€…çš„çŠ¶æ€** å’Œ **lifecycleæ­¤æ—¶å®é™…çŠ¶æ€** ,å¦‚æœ **å½“å‰è§‚å¯Ÿè€…çŠ¶æ€<lifecycleå¯¹åº”çš„çŠ¶æ€** ï¼Œåˆ™è§¦å‘ç›¸åº” `Event` çš„é€šçŸ¥,å¹¶ **æ›´æ–°æ­¤è§‚å¯Ÿè€…å¯¹åº”çš„çŠ¶æ€** ï¼Œä¸æ–­è½®è®­ï¼Œç›´åˆ°å½“å‰è§‚å¯Ÿè€…çŠ¶æ€ >= `lifecycle` å¯¹åº”çŠ¶æ€ã€‚

## å‚é˜…

- [Android-ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶å¤„ç†ç”Ÿå‘½å‘¨æœŸ](https://developer.android.com/topic/libraries/architecture/lifecycle?hl=zh-cn#additional-resources)



## å…³äºæˆ‘

æˆ‘æ˜¯ *Petterp* ,ä¸€ä¸ª Androidå·¥ç¨‹å¸ˆ ï¼Œå¦‚æœæœ¬æ–‡å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¯æŒï¼Œä½ çš„æ”¯æŒæ˜¯æˆ‘æŒç»­åˆ›ä½œçš„æœ€å¤§é¼“åŠ±ï¼



